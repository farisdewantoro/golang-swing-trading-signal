package telegram_bot

import (
	"context"
	"fmt"
	"golang-swing-trading-signal/internal/models"
	"golang-swing-trading-signal/internal/utils"
	"strconv"
	"strings"
	"sync"
	"time"

	"gopkg.in/telebot.v3"
)

func (t *TelegramBotService) FormatPositionMonitoringMessage(position *models.PositionMonitoringResponse) string {
	var sb strings.Builder

	sb.WriteString(fmt.Sprintf("üìä <b>Position Update: %s</b>\n", position.Symbol))
	sb.WriteString(fmt.Sprintf("üí∞ Buy: $%.2f | Current: $%.2f | P&L: %.2f%%\n", position.BuyPrice, position.CurrentPrice, position.PositionMetrics.UnrealizedPnLPercentage))
	sb.WriteString(fmt.Sprintf("üìà Age: %d days | Remaining: %d days\n\n", position.PositionAgeDays, position.PositionMetrics.DaysRemaining))

	// Recommendation
	sb.WriteString("üí° <b>Recommendation:</b>\n")
	sb.WriteString(fmt.Sprintf("Action: <b>%s</b>\n", position.Recommendation.Action))
	sb.WriteString(fmt.Sprintf("Reasoning: %s\n\n", position.Recommendation.Reasoning))

	// Technical Analysis
	sb.WriteString("üîß <b>Technical Analysis:</b>\n")
	sb.WriteString(fmt.Sprintf("Trend: %s\n", position.Recommendation.TechnicalAnalysis.Trend))
	sb.WriteString(fmt.Sprintf("EMA: %s | RSI: %s\n", position.Recommendation.TechnicalAnalysis.EMASignal, position.Recommendation.TechnicalAnalysis.RSISignal))
	sb.WriteString(fmt.Sprintf("MACD: %s\n", position.Recommendation.TechnicalAnalysis.MACDSignal))
	sb.WriteString(fmt.Sprintf("Support: $%.2f | Resistance: $%.2f\n", position.Recommendation.TechnicalAnalysis.SupportLevel, position.Recommendation.TechnicalAnalysis.ResistanceLevel))
	sb.WriteString(fmt.Sprintf("Technical Score: %d/100\n\n", position.Recommendation.TechnicalAnalysis.TechnicalScore))

	// News Summary
	sb.WriteString("üì∞ <b>News Summary:</b>\n")
	sb.WriteString(fmt.Sprintf("Confidence Score: %.2f\n", position.NewsSummary.ConfidenceScore))
	sb.WriteString(fmt.Sprintf("Sentiment: %s\n", position.NewsSummary.Sentiment))
	sb.WriteString(fmt.Sprintf("Impact: %s\n\n", position.NewsSummary.Impact))

	// Risk Analysis
	sb.WriteString("‚ö†Ô∏è <b>Risk Analysis:</b>\n")
	sb.WriteString(fmt.Sprintf("Current Profit: %.2f%%\n", position.Recommendation.RiskRewardAnalysis.CurrentProfitPercentage))
	sb.WriteString(fmt.Sprintf("Remaining Potential: %.2f%%\n", position.Recommendation.RiskRewardAnalysis.RemainingPotentialProfitPercentage))
	sb.WriteString(fmt.Sprintf("Risk/Reward Ratio: %.2f\n", position.Recommendation.RiskRewardAnalysis.RiskRewardRatio))
	sb.WriteString(fmt.Sprintf("Success Probability: %d%%\n\n", position.Recommendation.RiskRewardAnalysis.SuccessProbability))

	// Exit Strategy
	if position.Recommendation.RiskRewardAnalysis.ExitRecommendation.TargetExitPrice > 0 {
		sb.WriteString("üéØ <b>Exit Strategy:</b>\n")
		sb.WriteString(fmt.Sprintf("Target: $%.2f | Stop Loss: $%.2f\n",
			position.Recommendation.RiskRewardAnalysis.ExitRecommendation.TargetExitPrice,
			position.Recommendation.RiskRewardAnalysis.ExitRecommendation.StopLossPrice))
		if position.Recommendation.RiskRewardAnalysis.ExitRecommendation.TimeBasedExit != "" {
			if t, err := time.Parse(time.RFC3339, position.Recommendation.RiskRewardAnalysis.ExitRecommendation.TimeBasedExit); err == nil {
				sb.WriteString(fmt.Sprintf("Time Exit: %s\n", t.Format("2006-01-02 15:04:05")))
			}
		}
		if len(position.Recommendation.RiskRewardAnalysis.ExitRecommendation.ExitConditions) > 0 {
			sb.WriteString("Exit Conditions:\n")
			for i, condition := range position.Recommendation.RiskRewardAnalysis.ExitRecommendation.ExitConditions {
				if i < 2 { // Limit to 2 most important conditions
					sb.WriteString(fmt.Sprintf("‚Ä¢ %s\n", condition))
				}
			}
		}
		sb.WriteString("\n")
	}

	// Summary
	if position.TechnicalSummary.OverallSignal != "" {
		sb.WriteString("üìã <b>Summary:</b>\n")
		sb.WriteString(fmt.Sprintf("Signal: %s | Confidence: %d%%\n", position.TechnicalSummary.OverallSignal, position.TechnicalSummary.ConfidenceLevel))
		if len(position.TechnicalSummary.KeyInsights) > 0 {
			sb.WriteString("Key Insights:\n")
			for _, insight := range position.TechnicalSummary.KeyInsights {
				sb.WriteString(fmt.Sprintf("‚Ä¢ %s\n", insight))

			}
		}

		if len(position.NewsSummary.KeyIssues) > 0 {
			for _, issue := range position.NewsSummary.KeyIssues {
				sb.WriteString(fmt.Sprintf("‚Ä¢ %s\n", issue))

			}
		}
	}

	return sb.String()
}

func (t *TelegramBotService) FormatBulkPositionMonitoringMessage(positions []models.PositionMonitoringResponse) []string {
	const maxLen = 4090
	var messages []string
	var currentMessage strings.Builder
	part := 1

	now := utils.TimeNowWIB()
	// Helper function to start a new message part with the correct header
	startNewPart := func() {
		currentMessage.Reset()
		var header string
		if part == 1 {
			header = "üìä <b>Position Update Harian </b>\n"
		} else {
			header = fmt.Sprintf("---*Lanjutan Position Update Harian Part %d*---\n\n", part)
		}
		currentMessage.WriteString(header)
		currentMessage.WriteString(utils.PrettyDate(now) + "\n\n")
	}

	// Start the first part
	startNewPart()

	for _, position := range positions {

		var entryBuilder strings.Builder
		entryBuilder.WriteString(fmt.Sprintf("üíº <b>$%s</b>\n", position.Symbol))
		entryBuilder.WriteString(fmt.Sprintf("üí∞ Buy: $%.2f | Current: $%.2f | P&L: %.2f%%\n", position.BuyPrice, position.CurrentPrice, position.PositionMetrics.UnrealizedPnLPercentage))
		entryBuilder.WriteString(fmt.Sprintf("üìà Age: %d days | Remaining: %d days\n", position.PositionAgeDays, position.PositionMetrics.DaysRemaining))
		entryBuilder.WriteString(fmt.Sprintf("üéØ TP: $%.2f | SL: $%.2f\n",
			position.Recommendation.RiskRewardAnalysis.ExitRecommendation.TargetExitPrice,
			position.Recommendation.RiskRewardAnalysis.ExitRecommendation.StopLossPrice))
		// Suggested Action with icon
		var actionIcon string
		switch strings.ToLower(position.Recommendation.Action) {
		case "buy":
			actionIcon = "üü¢"
		case "sell":
			actionIcon = "üî¥"
		default: // Hold, Neutral
			actionIcon = "üü°"
		}

		entryBuilder.WriteString(fmt.Sprintf("üìå Action: %s %s\n", actionIcon, position.Recommendation.Action))
		entryBuilder.WriteString(fmt.Sprintf("üß† Success Probability: %d%%\n", position.Recommendation.RiskRewardAnalysis.SuccessProbability))
		entryBuilder.WriteString(fmt.Sprintf("üîç Reasoning: %s\n\n\n", position.Recommendation.Reasoning))

		// Check if adding the new entry exceeds the max length. We assume a single entry doesn't exceed the limit.
		if currentMessage.Len()+len(entryBuilder.String()) > maxLen {
			// Finalize the current message and add it to the slice
			messages = append(messages, currentMessage.String())

			// Start a new part
			part++
			startNewPart()
		}

		// Add the entry to the current message
		currentMessage.WriteString(entryBuilder.String())
	}

	// Add the final message part to the slice
	messages = append(messages, currentMessage.String())

	return messages
}

// formatDuration formats duration in a human-readable format
func formatDuration(d time.Duration) string {
	if d < time.Minute {
		return fmt.Sprintf("%.0f seconds", d.Seconds())
	}
	minutes := int(d.Minutes())
	seconds := int(d.Seconds()) % 60
	return fmt.Sprintf("%d minutes %d seconds", minutes, seconds)
}

// FormatBuyListSummaryMessage formats the buy list analysis summary for Telegram
func (t *TelegramBotService) FormatBuyListSummaryMessage(summary *models.SummaryAnalysisResponse, analysisTime time.Duration) string {
	var sb strings.Builder

	sb.WriteString("üìä <b>BUY LIST ANALYSIS SUMMARY</b>\n")
	sb.WriteString(fmt.Sprintf("üìÖ Date: %s\n", summary.AnalysisDate.Format("2006-01-02 15:04:05")))
	sb.WriteString(fmt.Sprintf("‚è±Ô∏è Analysis Time: %s\n", formatDuration(analysisTime)))
	sb.WriteString(fmt.Sprintf("üìà Total Stocks: %d | Buy: %d | Hold: %d\n\n", summary.TotalStocks, summary.BuyCount, summary.HoldCount))

	sb.WriteString("üìã <b>MARKET OVERVIEW:</b>\n")
	sb.WriteString(fmt.Sprintf("Best Opportunity: %s\n", summary.Summary.BestOpportunity))
	sb.WriteString(fmt.Sprintf("Worst Opportunity: %s\n\n", summary.Summary.WorstOpportunity))

	// Buy List Summary
	if len(summary.BuyList) > 0 {
		// Show top 3 stocks with highest confidence
		sb.WriteString("üèÜ <b>TOP RECOMMENDATIONS:</b>\n")
		for i, stock := range summary.BuyList {
			if i >= 3 { // Limit to top 3
				break
			}
			sb.WriteString(fmt.Sprintf("%d. <b>%s</b> - $%.2f (Confidence: %d%%)\n", i+1, stock.Symbol, stock.CurrentPrice, stock.Confidence))
		}
		sb.WriteString("\nüìã Detailed list will be sent in the next message...\n")
	} else {
		sb.WriteString("üü¢ <b>RECOMMENDED BUY LIST:</b> No stocks recommended for buying at this time\n\n")
	}

	return sb.String()
}

// FormatDetailedStockListMessage formats the detailed stock list for Telegram
func (t *TelegramBotService) FormatDetailedStockListMessage(summary *models.SummaryAnalysisResponse) string {
	var sb strings.Builder

	sb.WriteString("üìã <b>DETAILED STOCK LIST</b>\n")
	sb.WriteString(fmt.Sprintf("üìÖ Analysis Date: %s\n\n", summary.AnalysisDate.Format("2006-01-02 15:04:05")))

	if len(summary.BuyList) > 0 {
		sb.WriteString("üü¢ <b>RECOMMENDED BUY LIST:</b>\n\n")
		for i, stock := range summary.BuyList {
			sb.WriteString(fmt.Sprintf("%d. <b>%s</b> - $%.2f\n", i+1, stock.Symbol, stock.CurrentPrice))
			sb.WriteString(fmt.Sprintf("   üí∞ Buy: $%.2f | Target: $%.2f | Cut Loss: $%.2f\n", stock.BuyPrice, stock.TargetPrice, stock.StopLoss))
			sb.WriteString(fmt.Sprintf("   üìà Profit: %.2f%% | Risk Reward Ratio: %.2f | Max Days: %d\n", stock.ProfitPercentage, stock.RiskRewardRatio, stock.MaxHoldingDays))
			sb.WriteString(fmt.Sprintf("   üéØ Confidence: %d%% | Risk: %s\n\n", stock.Confidence, stock.RiskLevel))
		}
	} else {
		sb.WriteString("üü¢ <b>RECOMMENDED BUY LIST:</b> No stocks recommended for buying at this time\n\n")
	}

	return sb.String()
}

// FormatBuyListMessage formats the buy list analysis for Telegram (keeping for backward compatibility)
func (t *TelegramBotService) FormatBuyListMessage(summary *models.SummaryAnalysisResponse) string {
	var sb strings.Builder

	sb.WriteString("üìä <b>BUY LIST ANALYSIS</b>\n")
	sb.WriteString(fmt.Sprintf("üìÖ Date: %s\n", summary.AnalysisDate.Format("2006-01-02 15:04:05")))
	sb.WriteString(fmt.Sprintf("üìà Total Stocks: %d | Buy: %d | Hold: %d\n\n", summary.TotalStocks, summary.BuyCount, summary.HoldCount))

	sb.WriteString("üìã <b>MARKET OVERVIEW:</b>\n")
	sb.WriteString(fmt.Sprintf("Best Opportunity: %s\n", summary.Summary.BestOpportunity))
	sb.WriteString(fmt.Sprintf("Worst Opportunity: %s\n\n", summary.Summary.WorstOpportunity))

	return sb.String()
}

func (t *TelegramBotService) FormatAnalysisMessage(analysis *models.IndividualAnalysisResponse) string {
	var sb strings.Builder

	sb.WriteString(fmt.Sprintf("üìä **Analysis for %s**\n", analysis.Symbol))
	sb.WriteString(fmt.Sprintf("üìÖ Date: %s\n", analysis.AnalysisDate.Format("2006-01-02 15:04:05")))
	sb.WriteString(fmt.Sprintf("üéØ Signal: **%s**\n\n", analysis.Recommendation.Action))

	// Technical Analysis Summary
	sb.WriteString("üîß **Technical Analysis:**\n")
	sb.WriteString(fmt.Sprintf("‚Ä¢ Trend: %s \n", analysis.TechnicalAnalysis.Trend))
	sb.WriteString(fmt.Sprintf("‚Ä¢ EMA Signal: %s\n", analysis.TechnicalAnalysis.EMASignal))
	sb.WriteString(fmt.Sprintf("‚Ä¢ RSI: %s\n", analysis.TechnicalAnalysis.RSISignal))
	sb.WriteString(fmt.Sprintf("‚Ä¢ MACD: %s\n", analysis.TechnicalAnalysis.MACDSignal))
	sb.WriteString(fmt.Sprintf("‚Ä¢ Momentum: %s\n", analysis.TechnicalAnalysis.Momentum))
	sb.WriteString(fmt.Sprintf("‚Ä¢ Bollinger Bands Position: %s\n", analysis.TechnicalAnalysis.BollingerBandsPosition))
	sb.WriteString(fmt.Sprintf("‚Ä¢ Support Level: $%.2f\n", analysis.TechnicalAnalysis.SupportLevel))
	sb.WriteString(fmt.Sprintf("‚Ä¢ Resistance Level: $%.2f\n", analysis.TechnicalAnalysis.ResistanceLevel))
	sb.WriteString(fmt.Sprintf("‚Ä¢ Technical Score: %d/100\n", analysis.TechnicalAnalysis.TechnicalScore))
	if len(analysis.TechnicalAnalysis.KeyInsights) > 0 {
		sb.WriteString("\nüìå **Key Insights:**\n")
		for _, insight := range analysis.TechnicalAnalysis.KeyInsights {
			sb.WriteString(fmt.Sprintf("‚Ä¢ %s\n", utils.CapitalizeSentence(insight)))
		}
		sb.WriteString("\n")
	}

	// News Summary
	sb.WriteString("üì∞ **News Summary Analysis:**\n")
	sb.WriteString(fmt.Sprintf("Confidence Score: %.2f\n", analysis.NewsSummary.ConfidenceScore))
	sb.WriteString(fmt.Sprintf("Sentiment: %s\n", analysis.NewsSummary.Sentiment))
	sb.WriteString(fmt.Sprintf("Impact: %s\n\n", analysis.NewsSummary.Impact))

	sb.WriteString("üóû **Key Issues:**\n")
	if len(analysis.NewsSummary.KeyIssues) > 0 {
		for _, issue := range analysis.NewsSummary.KeyIssues {
			sb.WriteString(fmt.Sprintf("‚Ä¢ %s\n", utils.CapitalizeSentence(issue)))
		}
	}
	sb.WriteString("\n")

	// Recommendation
	sb.WriteString("üí° **Recommendation:**\n")
	sb.WriteString(fmt.Sprintf("‚Ä¢ üíµ Buy Price: $%.2f\n", analysis.Recommendation.BuyPrice))
	sb.WriteString(fmt.Sprintf("‚Ä¢ üéØ Target Price: $%.2f\n", analysis.Recommendation.TargetPrice))
	sb.WriteString(fmt.Sprintf("‚Ä¢ üõ° Stop Loss: $%.2f\n", analysis.Recommendation.CutLoss))
	sb.WriteString(fmt.Sprintf("‚Ä¢ üîÅ Risk/Reward Ratio: %.2f\n", analysis.Recommendation.RiskRewardRatio))
	sb.WriteString(fmt.Sprintf("‚Ä¢ üìä Confidence: %d%%\n\n", analysis.Recommendation.ConfidenceLevel))
	// Reasoning
	sb.WriteString(fmt.Sprintf("üß† **Reasoning:**\n %s\n\n", analysis.Recommendation.Reasoning))

	return sb.String()
}

func (t *TelegramBotService) FormatResultSetPositionMessage(data *models.RequestSetPositionData) string {
	var sb strings.Builder

	sb.WriteString("üíæ Posisi saham berhasil disimpan!\n\n")
	sb.WriteString("üìä Detail:\n")
	sb.WriteString("‚Äî Saham: " + data.Symbol + "\n")
	sb.WriteString("‚Äî Harga Beli: " + strconv.FormatFloat(data.BuyPrice, 'f', 0, 64) + "\n")
	sb.WriteString("‚Äî Tanggal Beli: " + data.BuyDate + "\n")
	sb.WriteString("‚Äî Take Profit: " + strconv.FormatFloat(data.TakeProfit, 'f', 0, 64) + "\n")
	sb.WriteString("‚Äî Stop Loss: " + strconv.FormatFloat(data.StopLoss, 'f', 0, 64) + "\n")
	sb.WriteString("‚Äî Max Hold: " + strconv.Itoa(data.MaxHolding) + " hari\n\n")

	if data.AlertPrice {
		sb.WriteString("üîî Alert harga *ON* ‚Äî sistem akan kirim notifikasi jika harga menyentuh TP atau SL.\n")
	} else {
		sb.WriteString("üîï Alert harga *OFF*.\n")
	}

	if data.AlertMonitor {
		sb.WriteString("üß† Monitoring *ON* ‚Äî kamu akan dapat laporan harian selama posisi masih berjalan.")
	} else {
		sb.WriteString("üß† Monitoring *OFF*.\n")
	}

	return sb.String()
}

func (t *TelegramBotService) FormatMyPositionMessage(position models.StockPositionEntity, index, total int) string {
	now := time.Now()
	age := int(now.Sub(position.BuyDate).Hours() / 24)
	if age < 0 {
		age = 0
	}
	remaining := position.MaxHoldingPeriodDays - age
	if remaining < 0 {
		remaining = 0
	}

	gain := float64(position.TakeProfitPrice-position.BuyPrice) / float64(position.BuyPrice) * 100
	loss := float64(position.BuyPrice-position.StopLossPrice) / float64(position.BuyPrice) * 100

	alertStatus := "‚úÖ Aktif"
	if position.PriceAlert == nil || !*position.PriceAlert {
		alertStatus = "‚ùå Tidak Aktif"
	}

	monitorStatus := "‚úÖ Aktif"
	if position.MonitorPosition == nil || !*position.MonitorPosition {
		monitorStatus = "‚ùå Tidak Aktif"
	}

	return fmt.Sprintf(
		"```\nüìä (%d/%d) Monitoring Saham\n\n"+
			"üì¶ %s\n"+
			"‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ\n"+
			"üí∞ Harga Beli   : %.2f\n"+
			"üéØ Target Jual  : %.2f (+%.1f%%)\n"+
			"üõë Stop Loss    : %.2f (‚àí%.1f%%)\n"+
			"üìÖ Tgl Beli     : %s\n"+
			"‚è≥ Umur Posisi  : %d hari\n"+
			"‚åõ Sisa Waktu   : %d hari\n"+
			"‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ\n"+
			"üîî Alert        : %s\n"+
			"üì° Monitoring   : %s\n"+
			"‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ\n```",
		index, total,
		position.StockCode,
		position.BuyPrice,
		position.TakeProfitPrice, gain,
		position.StopLossPrice, loss,
		position.BuyDate.Format("02 Jan 2006"),
		age,
		remaining,
		alertStatus,
		monitorStatus,
	)
}

func (t *TelegramBotService) FormatMyStockPositionMessage(position models.StockPositionEntity) string {
	now := time.Now()
	age := int(now.Sub(position.BuyDate).Hours() / 24)
	if age < 0 {
		age = 0
	}
	remaining := position.MaxHoldingPeriodDays - age
	if remaining < 0 {
		remaining = 0
	}

	gain := float64(position.TakeProfitPrice-position.BuyPrice) / float64(position.BuyPrice) * 100
	loss := float64(position.BuyPrice-position.StopLossPrice) / float64(position.BuyPrice) * 100

	alertStatus := "‚úÖ Aktif"
	if position.PriceAlert == nil || !*position.PriceAlert {
		alertStatus = "‚ùå Tidak Aktif"
	}

	monitorStatus := "‚úÖ Aktif"
	if position.MonitorPosition == nil || !*position.MonitorPosition {
		monitorStatus = "‚ùå Tidak Aktif"
	}

	return fmt.Sprintf(
		"```\nüìä Monitoring Saham\n\n"+
			"üì¶ %s\n"+
			"‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ\n"+
			"üí∞ Harga Beli   : %.2f\n"+
			"üéØ Target Jual  : %.2f (+%.1f%%)\n"+
			"üõë Stop Loss    : %.2f (‚àí%.1f%%)\n"+
			"üìÖ Tgl Beli     : %s\n"+
			"‚è≥ Umur Posisi  : %d hari\n"+
			"‚åõ Sisa Waktu   : %d hari\n"+
			"‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ\n"+
			"üîî Alert        : %s\n"+
			"üì° Monitoring   : %s\n"+
			"‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ\n```",
		position.StockCode,
		position.BuyPrice,
		position.TakeProfitPrice, gain,
		position.StopLossPrice, loss,
		position.BuyDate.Format("02 Jan 2006"),
		age,
		remaining,
		alertStatus,
		monitorStatus,
	)
}

func (t *TelegramBotService) FormatNotesTimeFrameStockMessage() string {
	return `
Berikut adalah penjelasan singkat tentang setiap time frame:
‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ

üîπ *Main Signal*  
‚è±Ô∏è Time Frame: 1 hari  |  üìÖ Range: 3 bulan  
üìå Untuk melihat arah tren besar saham.  
üëâ Cocok kalau kamu ingin tahu apakah saham ini sedang bagus untuk dibeli.

üîπ *Entry Presisi*  
‚è±Ô∏è Time Frame: 4 jam  |  üìÖ Range: 1 bulan  
üìå Untuk cari waktu terbaik masuk setelah sinyal beli muncul.  
üëâ Cocok kalau kamu sudah yakin mau beli, tapi ingin harga yang lebih pas.

üîπ *Exit Presisi*  
‚è±Ô∏è Time Frame: 1 jam  |  üìÖ Range: 14 hari  
üìå Untuk bantu kamu ambil untung atau cut loss.  
üëâ Cocok kalau kamu sudah punya saham dan ingin tahu kapan jual.
`
}

func (t *TelegramBotService) ShowAnalysisInProgress(stockCode string, interval string, period string) string {
	return fmt.Sprintf(`
üîç Sedang menganalisis *$%s*...

üïê Interval: %s  
üìÜ Range: %s

‚è≥ Mohon tunggu sebentar, bot sedang memproses data:
- Mengambil data harga üìà
- Menghitung sinyal teknikal üìä
- Menyusun rekomendasi üí°

üì¨ Hasil analisa akan muncul dalam beberapa detik...
`, stockCode, interval, period)

}

func (t *TelegramBotService) showLoadingFlowAnalysis(c telebot.Context, stop <-chan struct{}) *telebot.Message {
	msgRoot := c.Message()
	initial := "Sedang menganalisis saham kamu, mohon tunggu"

	var msg *telebot.Message
	var err error

	// Cek apakah pesan terakhir berasal dari bot
	if msgRoot == nil || msgRoot.Sender == nil || !msgRoot.Sender.IsBot {
		msg, err = t.bot.Send(c.Chat(), initial, &telebot.SendOptions{ParseMode: telebot.ModeMarkdown})
		if err != nil {
			t.logger.WithError(err).Error("Failed to send loading message")
			return nil
		}
	} else {
		msg, err = t.bot.Edit(msgRoot, initial)
		if err != nil {
			t.logger.WithError(err).Error("Failed to edit loading message")
			return nil
		}
	}

	go func() {
		dots := []string{"‚è≥", "‚è≥‚è≥", "‚è≥‚è≥‚è≥"}
		i := 0
		for {
			if utils.ShouldStopChan(stop, t.logger) {
				return
			}
			_, err := t.bot.Edit(msg, fmt.Sprintf("%s%s", initial, dots[i%len(dots)]))
			if err != nil {
				t.logger.WithError(err).Error("Failed to update loading animation")
				return
			}
			i++
			time.Sleep(200 * time.Millisecond)
		}
	}()

	return msg
}

func (t *TelegramBotService) showLoadingGeneral(c telebot.Context, stop <-chan struct{}) *telebot.Message {
	msgRoot := c.Message()

	initial := "Mohon tunggu sebentar, bot sedang memproses data"
	msg, _ := t.bot.Edit(msgRoot, initial)

	go func() {
		dots := []string{"‚è≥", "‚è≥‚è≥", "‚è≥‚è≥‚è≥"}
		i := 0
		for {
			if utils.ShouldStopChan(stop, t.logger) {
				return
			}
			_, err := t.bot.Edit(msg, fmt.Sprintf("%s%s", initial, dots[i%len(dots)]))
			if err != nil {
				t.logger.WithError(err).Error("Failed to update loading animation")
				return
			}
			i++
			time.Sleep(200 * time.Millisecond)
		}
	}()

	return msg
}

func (t *TelegramBotService) showLoadingBuyList(c telebot.Context, stockCode string, msgRoot *telebot.Message, stop <-chan struct{}, result *strings.Builder) *telebot.Message {
	steps := []string{
		fmt.Sprintf("üìä *Sedang menganalisis saham %s...*\n", stockCode),
		"üîç Langkah 1: Mengecek pergerakan harga (OHLC)...",
		"üóûÔ∏è Langkah 2: Memindai berita dan sentimen pasar...",
		"üß† Langkah 3: AI sedang melakukan analisa teknikal & fundamental...",
		"\nMohon tunggu sebentar, hasil segera keluar...",
	}

	stepsCount := 0

	sb := &strings.Builder{}
	sb.WriteString(result.String())
	sb.WriteString("\n")
	sb.WriteString(steps[stepsCount])

	utils.SafeGo(func() {
		dots := []string{"‚è≥", "‚è≥‚è≥", "‚è≥‚è≥‚è≥"}
		i := 0
		stepsCount++
		for {
			if utils.ShouldStopChan(stop, t.logger) {
				return
			}

			if stepsCount < len(steps) {
				sb.WriteString("\n" + steps[stepsCount])
				stepsCount++
				_, err := t.bot.Edit(msgRoot, sb.String(), telebot.ModeMarkdown)
				if err != nil {
					t.logger.WithError(err).Error("Failed to update loading animation")
					return
				}

				if stepsCount < len(steps) {
					time.Sleep(200 * time.Millisecond)
					sb.WriteString("‚úÖ")
					_, err = t.bot.Edit(msgRoot, sb.String(), telebot.ModeMarkdown)
					if err != nil {
						t.logger.WithError(err).Error("Failed to update loading animation")
						return
					}
				}

				continue
			}

			_, err := t.bot.Edit(msgRoot, fmt.Sprintf("%s%s", sb.String(), dots[i%len(dots)]), telebot.ModeMarkdown)
			if err != nil {
				t.logger.WithError(err).Error("Failed to update loading animation")
				return
			}
			i++
			time.Sleep(400 * time.Millisecond)
		}
	})

	return msgRoot
}

type Progress struct {
	Index     int
	StockCode string
	Content   string
	Header    string
}

func (t *TelegramBotService) showProgressBarWithChannel(
	ctx context.Context,
	c telebot.Context,
	msgRoot *telebot.Message,
	progressCh <-chan Progress,
	totalSteps int,
	wg *sync.WaitGroup,
) {
	utils.SafeGo(func() {
		const barLength = 15 // total panjang bar, bisa diubah sesuai estetika

		current := Progress{Index: 0}

		defer func() {
			result := fmt.Sprintf("%s\n%s", current.Header, current.Content)
			_, errInner := t.telegramRateLimiter.EditWithoutLimit(ctx, c, msgRoot, result, &telebot.ReplyMarkup{}, telebot.ModeMarkdown)
			if errInner != nil {
				t.logger.WithError(errInner).Error("Gagal edit pesan")
			}
			wg.Done()
		}()

		for {
			select {
			case <-ctx.Done():
				t.logger.WithError(ctx.Err()).Error("Done signal received")

				return

			case newProgress, ok := <-progressCh:
				if !ok {
					t.logger.Warn("showProgressBarWithChannel - Progress channel closed")
					return
				}

				current = newProgress

				// Hitung persen dan jumlah "blok" progress
				percent := int(float64(current.Index) / float64(totalSteps) * 100)
				progressBlocks := int(float64(barLength) * float64(current.Index) / float64(totalSteps))
				if progressBlocks > barLength {
					progressBlocks = barLength
				}

				// Buat bar: ‚ñì untuk progress, ‚ñë untuk sisanya
				currentAnalysis := fmt.Sprintf(messageLoadingAnalysis, current.StockCode)
				filled := strings.Repeat("‚ñì", progressBlocks)
				empty := strings.Repeat("‚ñë", barLength-progressBlocks)
				progressBar := fmt.Sprintf("‚è≥ Progress: [%s%s] %d%%", filled, empty, percent)

				menu := &telebot.ReplyMarkup{}
				btnCancel := menu.Data(btnCancelBuyListAnalysis.Text, btnCancelBuyListAnalysis.Unique)
				menu.Inline(menu.Row(btnCancel))

				body := &strings.Builder{}
				body.WriteString(current.Header)
				body.WriteString("\n")

				if current.Content != "" {
					body.WriteString(current.Content)
					body.WriteString("\n\n")
				}

				body.WriteString(currentAnalysis)
				body.WriteString("\n")
				body.WriteString(progressBar)

				time.Sleep(100 * time.Millisecond)

				if msgRoot == nil {
					msgNew, err := t.telegramRateLimiter.Send(ctx, c, body.String(), menu, telebot.ModeMarkdown)
					if err != nil {
						t.logger.WithError(err).Error("Gagal create progress bar")
					}
					msgRoot = msgNew
				} else {
					_, err := t.telegramRateLimiter.Edit(ctx, c, msgRoot, body.String(), menu, telebot.ModeMarkdown)
					if err != nil {
						t.logger.WithError(err).Error("Gagal update progress bar")
					}
				}

			}
		}
	})
}

func (t *TelegramBotService) formatMessageBuyList(index int, analysis *models.IndividualAnalysisResponse) *strings.Builder {
	profitPercentage := ((analysis.Recommendation.TargetPrice - analysis.Recommendation.BuyPrice) / analysis.Recommendation.BuyPrice) * 100
	sb := &strings.Builder{}
	sb.WriteString(fmt.Sprintf("\n‚Ä¢ `$%s`\n", analysis.Symbol))
	sb.WriteString(fmt.Sprintf("   üíµ Buy: %d\n", int(analysis.Recommendation.BuyPrice)))
	sb.WriteString(fmt.Sprintf("   üéØ TP: %d  üõ° SL: %d\n", int(analysis.Recommendation.TargetPrice), int(analysis.Recommendation.CutLoss)))
	sb.WriteString(fmt.Sprintf("   üîÅ RR: %.1f   üí∞ Profit: +%.1f%%", analysis.Recommendation.RiskRewardRatio, profitPercentage))

	return sb

}

func (t *TelegramBotService) formatMessageMenuNews() string {
	result := `üìã Menu Berita Saham

Tetap update dengan pergerakan pasar.
Cari berita saham, aktifkan rangkuman harian,
atau nyalakan alert otomatis saat muncul berita penting
yang bisa mempengaruhi harga saham.

Pilih fitur yang ingin kamu akses:`

	return result

}

func (t *TelegramBotService) formatMessageNewsList(newsList []models.StockNewsEntity, age int) string {
	sb := &strings.Builder{}
	sb.WriteString(fmt.Sprintf("üì¢ Berikut adalah rangkuman berita penting terbaru yang berkaitan dengan saham $%s dalam %d hari terakhir", newsList[0].StockCode, age))

	for idx, news := range newsList {
		sb.WriteString(fmt.Sprintf("\n\n %d. %s\n", idx+1, utils.TruncateTitle(news.Title, 80)))
		sb.WriteString(fmt.Sprintf(" üìÖ %s | üåê %s\n", news.PublishedAt.Format("2006-01-02"), utils.ExtractDomain(news.Link)))
		sb.WriteString(fmt.Sprintf(" üìä Sentimen: %s | üíØ Score: %.2f\n", news.Sentiment, news.FinalScore))
		sb.WriteString(fmt.Sprintf(" üß† %s\n", utils.TruncateTitle(news.Reason, 200)))
		link := fmt.Sprintf("[Selengkapnya](%s)", news.Link)
		sb.WriteString(fmt.Sprintf(" üîó %s\n", link))
	}
	sb.WriteString("\n")

	return sb.String()
}

func (t *TelegramBotService) formatMessageNewsSummary(summary *models.StockNewsSummaryEntity) string {

	action := strings.ToUpper(summary.SuggestedAction)
	iconAction := "‚ùî"
	if action == "HOLD" {
		iconAction = "üü°"
	} else if action == "SELL" {
		iconAction = "üî¥"
	} else if action == "BUY" {
		iconAction = "üü¢"
	}

	sb := &strings.Builder{}
	sb.WriteString(fmt.Sprintf("üìö *Ringkasan Analisis Saham $%s*\n\n", summary.StockCode))
	sb.WriteString(fmt.Sprintf("üìù *TL;DR:* %s\n\n", summary.ShortSummary))
	sb.WriteString(fmt.Sprintf("üß† *Sentimen:* %s\n", summary.SummarySentiment))
	sb.WriteString(fmt.Sprintf("üìà *Dampak:* %s\n", summary.SummaryImpact))
	sb.WriteString(fmt.Sprintf("üìâ *Confidence Score:* %.2f\n", summary.SummaryConfidenceScore))
	sb.WriteString(fmt.Sprintf("üéØ *Saran:* %s %s\n", iconAction, action))
	sb.WriteString("\nüîë *Isu Kunci:*\n")
	for _, issue := range summary.KeyIssues {
		sb.WriteString(fmt.Sprintf("‚Ä¢ %s\n", issue))
	}
	sb.WriteString(fmt.Sprintf("\nüß© *Alasan:* %s\n\n", summary.Reasoning))
	sb.WriteString(fmt.Sprintf("üìÜ *Periode:* %s - %s\n", summary.SummaryStart.Format("2006-01-02"), summary.SummaryEnd.Format("2006-01-02")))

	return sb.String()
}
